<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>mihalichparty.fun ‚Äî –æ—Ñ—ñ—Ü—ñ–∞–ª—å–Ω–∏–π —Å–∞–π—Ç –¥–æ–ª–∂–Ω—ñ–∫–æ–≤ –ú—ñ—Ö–∞–ª–∏—á–∞</title>
  <style>
    :root {
      --bg: #0d0d10;
      --card-bg: #18181f;
      --border-soft: #27272f;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --accent: #ff7b39;
      --accent-soft: #f97316;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
    }

    a {
      color: var(--accent-soft);
      text-decoration: none;
    }

    a:hover { text-decoration: underline; }

    /* HEADER */

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #111827;
      background: rgba(15, 15, 20, 0.96);
      backdrop-filter: blur(14px);
    }

    .logo-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .logo span {
      color: var(--accent);
    }

    .subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav-btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn span.icon {
      font-size: 14px;
    }

    .nav-btn.active {
      background: #1f2933;
      border-color: #374151;
      color: var(--accent);
    }

    .nav-btn:hover {
      background: #111827;
    }

    /* LAYOUT */

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .page {
      display: none;
    }
    .page.active {
      display: block;
    }

    .layout-two {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }

    .layout-one {
      max-width: 900px;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .layout-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* CARDS */

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 14px 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    }

    .card-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      color: var(--text-muted);
      background: #111827;
      text-transform: uppercase;
    }

    .divider {
      height: 1px;
      background: #1f2937;
      margin: 8px 0 10px;
    }

    .small-text {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* INPUTS / BUTTONS */

    .input,
    textarea,
    .select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #050712;
      padding: 8px 10px;
      color: var(--text-main);
      font-size: 13px;
      font-family: inherit;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      background: var(--accent);
      color: #111827;
      font-weight: 600;
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-sm {
      font-size: 11px;
      padding: 4px 10px;
    }

    .btn-ghost {
      background: transparent;
      border-color: #374151;
      color: var(--text-muted);
    }

    .btn-danger {
      background: #b91c1c;
      border-color: #ef4444;
      color: #fee2e2;
    }

    .btn:hover {
      filter: brightness(1.05);
    }

    /* PROFILE SUMMARY (SIDEBAR) */

    .profile-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid #374151;
      background: #020617;
      flex-shrink: 0;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 14px;
      font-weight: 600;
    }

    .profile-tagline {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-voice {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px dashed #4b5563;
      color: var(--accent-soft);
      background: #020617;
    }

    /* FEED */

    .feed-new {
      margin-bottom: 14px;
    }

    .feed-list {
      min-height: 160px;
      max-height: 480px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .post {
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .post-user {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .post-user img {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      object-fit: cover;
    }

    .post-name {
      color: var(--accent-soft);
      font-weight: 500;
    }

    .post-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      color: var(--text-muted);
    }

    .post-image {
      margin-top: 6px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #111827;
      max-height: 220px;
    }

    .post-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* VOICE LIST (SIDEBAR + PAGE) */

    .voice-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 6px;
    }

    .voice-item {
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 6px 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .voice-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }

    .voice-top {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .voice-text {
      font-size: 12px;
    }

    /* PAINT */

    .draw-wrapper {
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 10px;
    }

    canvas {
      width: 100%;
      height: 260px;
      background: #050712;
      border-radius: 10px;
      cursor: crosshair;
      display: block;
    }

    .draw-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .color-palette {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .color-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #111827;
      cursor: pointer;
    }

    /* GAMES */

    .game-box {
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px 10px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .score-badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #4ade80;
      color: #bbf7d0;
      background: #052e16;
      display: inline-block;
      margin-bottom: 6px;
    }

    .leaderboard {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 12px;
      margin-top: 6px;
    }

    .lb-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed #1f2937;
    }

    .lb-row span:first-child {
      color: var(--accent-soft);
    }

    /* FOOTER */

    footer {
      border-top: 1px solid #111827;
      padding: 10px 16px 18px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      background: #020617;
    }

    /* SCROLLBAR */

    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #050712;
    }
    ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 999px;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-block">
    <div class="logo">mihalich<span>party.fun</span></div>
    <div class="subtitle">
      –æ—Ñ—ñ—Ü—ñ–∞–ª—å–Ω–∏–π –ø–æ—Ä—Ç–∞–ª –¥–æ–ª–∂–Ω—ñ–∫–æ–≤, –µ–º–æ—á–µ–∫ —ñ –∫—Ä—ñ–Ω–∂-–∫–æ—Ä–æ–ª—ñ–≤. –º—ñ—Ö–∞–ª–∏—á —Å–ª—ñ–¥–∫—É—î üëÅ
    </div>
  </div>
  <nav>
    <button class="nav-btn active" data-page="feed"><span class="icon">üì∞</span>Feed</button>
    <button class="nav-btn" data-page="paint"><span class="icon">üé®</span>Paint</button>
    <button class="nav-btn" data-page="games"><span class="icon">üïπ</span>Games</button>
    <button class="nav-btn" data-page="account"><span class="icon">‚öôÔ∏è</span>Account</button>
  </nav>
</header>

<main>

  <!-- FEED PAGE -->
  <section id="page-feed" class="page active">
    <div class="layout-two">

      <!-- LEFT: FEED -->
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">–§—ñ–¥ –¥–æ–ª–∂–Ω—ñ–∫–æ–≤</div>
            <div class="card-subtitle">–ü–æ—Å—Ç–∏ –±–∞—á–∞—Ç—å –≤—Å—ñ, —Ö—Ç–æ –≤—ñ–¥–∫—Ä–∏–≤ —Å–∞–π—Ç. –ú–µ–º–∏, –¥–µ–ø—Ä–∞, –º—É–∑–æ–Ω ‚Äî –≤—Å–µ —Å—é–¥–∏.</div>
          </div>
          <span class="pill">feed</span>
        </div>
        <div class="divider"></div>

        <div class="feed-new">
          <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ, –¥–æ–ª–∂–Ω—ñ–∫—É?"></textarea>
          <div class="btn-row">
            <input id="postImageUrl" class="input" placeholder="URL –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" />
          </div>
          <div class="btn-row">
            <button class="btn btn-sm" onclick="createPost()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
            <button class="btn btn-ghost btn-sm" onclick="generateRandomPost()">–†–∞–Ω–¥–æ–º–Ω–∏–π –ø–æ—Å—Ç</button>
            <button class="btn btn-danger btn-sm" onclick="clearMyPosts()">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ</button>
          </div>
          <p class="small-text" style="margin-top:6px;">
            ‚ö† –ü–æ—Å—Ç–∏ –ª–µ—Ç—è—Ç—å –≤ Firebase Firestore ‚Äî –∑–∞–≥–∞–ª—å–Ω–∏–π —Ñ—ñ–¥ –¥–ª—è –≤—Å—ñ—Ö, —Ö—Ç–æ –∑–∞–π–¥–µ –Ω–∞ —Å–∞–π—Ç.
          </p>
        </div>

        <div class="feed-list" id="feedList"></div>
      </div>

      <!-- RIGHT SIDEBAR -->
      <div class="sidebar">

        <!-- PROFILE SUMMARY -->
        <div class="card" style="margin-bottom:12px;">
          <div class="card-title-row">
            <div>
              <div class="card-title">–¢–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</div>
              <div class="card-subtitle">–¶–µ –∫–æ—Ä–æ—Ç–∫–∞ –≤–µ—Ä—Å—ñ—è –∞–∫–∫–∞—É–Ω—Ç–∞. –ü–æ–≤–Ω–∞ ‚Äî —É –≤–∫–ª–∞–¥—Ü—ñ Account.</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="profile-row">
            <div class="avatar">
              <img id="avatarPreviewSmall" src="https://i.imgur.com/4ZQZ4Yy.png" alt="avatar">
            </div>
            <div>
              <div class="profile-name" id="sidebarName">–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫</div>
              <div class="profile-tagline small-text" id="sidebarStatus">
                —Å—Ç–∞—Ç—É—Å: –≥—ñ—Å—Ç—å. –Ω–∞–ª–∞—à—Ç—É–π –ø—Ä–æ—Ñ—ñ–ª—å —É –≤–∫–ª–∞–¥—Ü—ñ Account.
              </div>
              <div style="margin-top:4px;">
                <span id="voiceBadgeSidebar" class="badge-voice">–ø—Ä–µ—Å–µ—Ç: normal</span>
              </div>
            </div>
          </div>
        </div>

        <!-- LEADERBOARD CARD -->
        <div class="card" style="margin-bottom:12px;">
          <div class="card-title-row">
            <div>
              <div class="card-title">–¢–æ–ø –¥–æ–ª–∂–Ω—ñ–∫–æ–≤</div>
              <div class="card-subtitle">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —ñ–≥–æ—Ä: —Ö—Ç–æ –Ω–∞–π–±—ñ–ª—å—à–µ –∫–ª—ñ–∫–∞–≤ —ñ —Ö—Ç–æ —à–≤–∏–¥—à–µ —Ä–µ–∞–≥—É—î.</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="leaderboard" id="leaderboard"></div>
        </div>

        <!-- VOICE ROOMS (SIDEBAR VIEW) -->
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">–ì–æ–ª–æ—Å–æ–≤—ñ –∫—ñ–º–Ω–∞—Ç–∏</div>
              <div class="card-subtitle">–§–µ–π–∫–æ–≤–∏–π Discord –≤—ñ–¥ –ú—ñ—Ö–∞–ª–∏—á–∞. –ü–∏—à–µ—à —Ç–µ–∫—Å—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä —á–∏—Ç–∞—î.</div>
            </div>
          </div>
          <div class="divider"></div>

          <textarea id="voiceInput" placeholder="–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ..."></textarea>
          <div class="btn-row">
            <button class="btn btn-sm" onclick="sendVoice()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ</button>
            <button class="btn btn-ghost btn-sm" onclick="testMyVoice()">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ç–∏ –º—ñ–π –≥–æ–ª–æ—Å</button>
          </div>

          <div class="voice-list" id="voiceList"></div>
        </div>

      </div>
    </div>
  </section>

  <!-- PAINT PAGE -->
  <section id="page-paint" class="page">
    <div class="layout-one">
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">–ú–∞–ª—é–≤–∞–ª–∫–∞</div>
            <div class="card-subtitle">–ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ö–æ–ª—Å—Ç. –ö–æ–∂–µ–Ω —à—Ç—Ä–∏—Ö –ª–µ—Ç–∏—Ç—å —É Firebase. –ú–∞–ª—é–π —Ç–∞–∫, —â–æ–± –ú—ñ—Ö–∞–ª–∏—á –Ω–µ –∑–∞–±–∞–Ω–∏–≤.</div>
          </div>
          <span class="pill">paint</span>
        </div>
        <div class="divider"></div>

        <div class="draw-wrapper">
          <canvas id="paintCanvas"></canvas>
          <div class="draw-controls">
            <span>–ö–æ–ª—ñ—Ä:</span>
            <div class="color-palette">
              <div class="color-dot" style="background:#f97316;" data-color="#f97316"></div>
              <div class="color-dot" style="background:#22c55e;" data-color="#22c55e"></div>
              <div class="color-dot" style="background:#3b82f6;" data-color="#3b82f6"></div>
              <div class="color-dot" style="background:#e5e7eb;" data-color="#e5e7eb"></div>
              <div class="color-dot" style="background:#ec4899;" data-color="#ec4899"></div>
              <div class="color-dot" style="background:#a855f7;" data-color="#a855f7"></div>
              <div class="color-dot" style="background:#facc15;" data-color="#facc15"></div>
              <div class="color-dot" style="background:#000000;" data-color="#000000"></div>
            </div>

            <span>–†–æ–∑–º—ñ—Ä:</span>
            <input type="range" id="drawSize" min="1" max="20" value="4" />
            <button class="btn btn-ghost btn-sm" onclick="clearLocalCanvas()">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ</button>
          </div>
          <p class="small-text" style="margin-top:6px;">
            ‚ö† –û—á–∏—Å—Ç–∫–∞ —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Ç–≤–æ—î–º—É –µ–∫—Ä–∞–Ω—ñ. –†–µ–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –≤ Firestore –ª–∏—à–∞—é—Ç—å—Å—è, —Ü–µ –∂ –ú—ñ—Ö–∞–ª–∏—á ‚Äî –≤—ñ–Ω –Ω—ñ—á–æ–≥–æ –Ω–µ –ø—Ä–æ—â–∞—î.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- GAMES PAGE -->
  <section id="page-games" class="page">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">–Ü–≥—Ä–∏ –ú—ñ—Ö–∞–ª–∏—á–∞</div>
              <div class="card-subtitle">–ú—ñ–Ω—ñ–º—É–º –¥–≤—ñ —Ç—É–ø—ñ —ñ–≥—Ä–∏, –º–∞–∫—Å–∏–º—É–º –ø–æ–≤–∞–≥–∞ –≤—ñ–¥ –ú—ñ—Ö–∞–ª–∏—á–∞.</div>
            </div>
            <span class="pill">games</span>
          </div>
          <div class="divider"></div>

          <!-- CLICKER -->
          <div class="game-box">
            <div class="score-badge" id="scoreClickBadge">clicker: 0</div>
            <p class="small-text">
              –Ü–≥—Ä–∞ ‚Ññ1: <b>¬´–ö–ª—ñ–∫–Ω–∏ –±–æ—Ä–≥¬ª</b>. –ü—Ä–æ—Å—Ç–æ —Ç–∏—Å–Ω–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, –∑–±–∏—Ä–∞–π –ø–æ—ñ–Ω—Ç–∏. –ü–æ—Ç—ñ–º –∫–∏–¥–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª—ñ–¥–µ—Ä–±–æ—Ä–¥.
            </p>
            <div class="btn-row">
              <button class="btn btn-sm" onclick="clickGame()">–ö–ª—ñ–∫–Ω—É—Ç–∏ –±–æ—Ä–≥</button>
              <button class="btn btn-ghost btn-sm" onclick="resetClickGame()">–û–±–Ω—É–ª–∏—Ç—å —Å–µ–±–µ</button>
              <button class="btn btn-sm" onclick="saveScore('clicker')">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ —Ç–æ–ø</button>
            </div>
            <p class="small-text" id="clickComment"></p>
          </div>

          <!-- REACTION -->
          <div class="game-box">
            <div class="score-badge" id="scoreReactBadge">reaction best: ‚Äî</div>
            <p class="small-text">
              –Ü–≥—Ä–∞ ‚Ññ2: <b>¬´–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –ú—ñ—Ö–∞–ª–∏—á–∞¬ª</b>. –ñ–º–∏ ¬´—Å—Ç–∞—Ä—Ç¬ª, —á–µ–∫–∞–π –∑–µ–ª–µ–Ω—É –∫–æ—Ä–æ–±–∫—É —ñ –∫–ª–∞—Ü–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–≤–∏–¥–∫–æ.
            </p>
            <div style="margin:6px 0;">
              <div id="reactBox" style="height:70px;border-radius:10px;background:#451a1a;display:flex;align-items:center;justify-content:center;font-size:13px;">
                –∂–¥—å–æ–º —Å—Ç–∞—Ä—Ç...
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-sm" onclick="startReactionGame()">–°—Ç–∞—Ä—Ç</button>
              <button class="btn btn-sm" onclick="saveScore('reaction')">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤ —Ç–æ–ø</button>
            </div>
            <p class="small-text" id="reactComment"></p>
          </div>
        </div>
      </div>

      <!-- RIGHT: LEADERBOARD DUPLICATE VIEW -->
      <div>
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">–¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤</div>
              <div class="card-subtitle">–¢—É—Ç –≤–∏–¥–Ω–æ, —Ö—Ç–æ –Ω–∞–π–±—ñ–ª—å—à–∏–π –∑–∞–¥—Ä–æ—Ç –ø–æ –∫–ª—ñ–∫–∞—Ö —ñ —Ä–µ–∞–∫—Ü—ñ—ó.</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="leaderboard" id="leaderboardGames"></div>
          <p class="small-text" style="margin-top:6px;">
            ‚ö† –¶–µ–π –∂–µ —Ç–æ–ø –≤–∏–¥–Ω–æ —ñ –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ Feed ‚Äî –≤—Å–µ –≤ –æ–¥–Ω–æ–º—É –≤—Å–µ—Å–≤—ñ—Ç—ñ Firebase.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- ACCOUNT PAGE -->
  <section id="page-account" class="page">
    <div class="layout-one">
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">–ê–∫–∫–∞—É–Ω—Ç –¥–æ–ª–∂–Ω—ñ–∫–∞</div>
            <div class="card-subtitle">–ù—ñ–∫, –∞–≤–∞—Ç–∞—Ä —ñ –≥–æ–ª–æ—Å–æ–≤–∏–π –ø—Ä–µ—Å–µ—Ç. –í—Å–µ, —â–æ —Ç—Ä–µ–±–∞ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –∫—Ä—ñ–Ω–∂-–æ–±—Ä–∞–∑—É.</div>
          </div>
          <span class="pill">account</span>
        </div>
        <div class="divider"></div>

        <div class="small-text" style="margin-bottom:10px;">
          –¶—ñ –¥–∞–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —É –ø–æ—Å—Ç–∞—Ö, –≥–æ–ª–æ—Å–æ–≤–∏—Ö —ñ –≤ —Ç–æ–ø—ñ —ñ–≥–æ—Ä. –í—Å–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ç–≤–æ—î–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;">
          <div class="avatar">
            <img id="avatarPreview" src="https://i.imgur.com/4ZQZ4Yy.png" alt="avatar">
          </div>
          <div style="flex:1;min-width:220px;">
            <input id="usernameInput" class="input" placeholder="–Ω—ñ–∫ (—Ç–∏–ø–æ '—à–ª–∞–∫_—ñ–∑_–ø—ñ–¥—ó–∑–¥–∞')" />
            <div style="height:8px;"></div>
            <input id="avatarInput" class="input" placeholder="URL –Ω–∞ –∞–≤–∞—Ç–∞—Ä (–∫–∞—Ä—Ç–∏–Ω–∫–∞)" />
          </div>
        </div>

        <div style="height:12px;"></div>

        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <span class="small-text">–ì–æ–ª–æ—Å:</span>
          <select id="voicePreset" class="select" style="max-width:220px;">
            <option value="base">normal (0 cents)</option>
            <option value="p200">pitch +200 (—á—É—Ç—å –≤–∏—â–µ)</option>
            <option value="m200">pitch -200 (—á—É—Ç—å –Ω–∏–∂—á–µ)</option>
            <option value="p400">pitch +400 (–∞–Ω—ñ–º–µ –º–∞–ª—å—á—ñ–∫)</option>
            <option value="m400">pitch -400 (–¥—è–¥—è –∑ –ø—ñ–¥–≤–∞–ª–∞)</option>
          </select>
          <span id="voiceBadge" class="badge-voice">–ø—Ä–µ—Å–µ—Ç: normal</span>
        </div>

        <div class="btn-row" style="margin-top:10px;justify-content:flex-end;">
          <button class="btn btn-sm" onclick="saveProfile()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <button class="btn btn-ghost btn-sm" onclick="resetProfile()">–û–±–Ω—É–ª–∏—Ç–∏</button>
        </div>

        <p class="small-text" id="accountStatus" style="margin-top:8px;">
          —Å—Ç–∞—Ç—É—Å: –≥—ñ—Å—Ç—å. –∑–±–µ—Ä–µ–∂–∏ –ø—Ä–æ—Ñ—ñ–ª—å, —â–æ–± —Å—Ç–∞—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º –¥–æ–ª–∂–Ω—ñ–∫–æ–º.
        </p>
      </div>
    </div>
  </section>

</main>

<footer>
  ¬© mihalichparty.fun ‚Äî —è–∫—â–æ —Ç–∏ —Ü–µ —á–∏—Ç–∞—î—à, —Ç–∏ –∞–≤—Ç–æ–º–∞—Ç—ñ—á–Ω–æ –¥–æ–ª–∂–µ–Ω 50 –≥—Ä–Ω.  
  –°–∞–π—Ç –≤–µ—Ä—Å—ñ—ó ¬´–¥–æ—Ä–æ—Å–ª–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –¥–∏—Ç—è—á–∏–π –∑–º—ñ—Å—Ç¬ª. –ú—ñ—Ö–∞–ª–∏—á –æ–¥–æ–±—Ä–∏–ª.
</footer>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
  // ------------------ 1. Firebase ------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAMt6y5Ys7a1wjiqftkoC_EsjHmcaJrvYo",
    authDomain: "mihalichpartyfun.firebaseapp.com",
    projectId: "mihalichpartyfun",
    storageBucket: "mihalichpartyfun.firebasestorage.app",
    messagingSenderId: "489168444978",
    appId: "1:489168444978:web:3b1970550ce6d39c03262b",
    measurementId: "G-BQZBY5JZXM"
  };

  let db = null;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase OK");
  } catch (e) {
    console.warn("Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω, –ø—Ä–∞—Ü—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –æ–Ω–ª–∞–π–Ω–∞.", e);
  }

  // ------------------ 2. SPA –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è ------------------
  const navButtons = document.querySelectorAll(".nav-btn");
  const pages = {
    feed: document.getElementById("page-feed"),
    paint: document.getElementById("page-paint"),
    games: document.getElementById("page-games"),
    account: document.getElementById("page-account"),
  };

  function setPage(page) {
    navButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.page === page);
    });
    Object.entries(pages).forEach(([key, el]) => {
      if (!el) return;
      el.classList.toggle("active", key === page);
    });

    // —Ñ—ñ–∫—Å –º–∞–ª—é–≤–∞–ª–∫–∏: –∫–æ–ª–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ Paint ‚Äî –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä canvas
    if (page === "paint") {
      setTimeout(() => {
        resizeCanvas();
      }, 50);
    }
  }

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => setPage(btn.dataset.page));
  });

  // ------------------ 3. –ü—Ä–æ—Ñ—ñ–ª—å (localStorage) ------------------
  const usernameInput = document.getElementById("usernameInput");
  const avatarInput = document.getElementById("avatarInput");
  const avatarPreview = document.getElementById("avatarPreview");
  const avatarPreviewSmall = document.getElementById("avatarPreviewSmall");
  const voicePreset = document.getElementById("voicePreset");
  const voiceBadge = document.getElementById("voiceBadge");
  const voiceBadgeSidebar = document.getElementById("voiceBadgeSidebar");
  const accountStatus = document.getElementById("accountStatus");
  const sidebarName = document.getElementById("sidebarName");
  const sidebarStatus = document.getElementById("sidebarStatus");

  const STORAGE_PROFILE = "mihalichparty_profile";

  let currentProfile = {
    name: "",
    avatar: "https://i.imgur.com/4ZQZ4Yy.png",
    voice: "base"
  };

  function syncProfileUI() {
    usernameInput.value = currentProfile.name || "";
    avatarInput.value = currentProfile.avatar || "";
    avatarPreview.src = currentProfile.avatar || "https://i.imgur.com/4ZQZ4Yy.png";
    avatarPreviewSmall.src = avatarPreview.src;
    voicePreset.value = currentProfile.voice || "base";
    updateVoiceBadge();

    if (currentProfile.name) {
      accountStatus.textContent = `—Å—Ç–∞—Ç—É—Å: –æ—Ñ—ñ—Ü—ñ–∞–ª—å–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫ –∑ –Ω—ñ–∫–æ–º "${currentProfile.name}".`;
      sidebarName.textContent = currentProfile.name;
      sidebarStatus.textContent = "–∂–∏–≤–µ—à —É –±–æ—Ä–≥–∞—Ö, –∞–ª–µ –∑ –æ–±—Ä–∞–∑–æ–º.";
    } else {
      accountStatus.textContent = "—Å—Ç–∞—Ç—É—Å: –≥—ñ—Å—Ç—å. –∑–±–µ—Ä–µ–∂–∏ –ø—Ä–æ—Ñ—ñ–ª—å —à–æ–± —Å—Ç–∞—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º –¥–æ–ª–∂–Ω—ñ–∫–æ–º.";
      sidebarName.textContent = "–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫";
      sidebarStatus.textContent = "–Ω–∞–ª–∞—à—Ç—É–π –ø—Ä–æ—Ñ—ñ–ª—å —É –≤–∫–ª–∞–¥—Ü—ñ Account.";
    }
  }

  function loadProfile() {
    try {
      const raw = localStorage.getItem(STORAGE_PROFILE);
      if (raw) currentProfile = JSON.parse(raw);
    } catch (e) {}
    syncProfileUI();
  }

  function saveProfile() {
    currentProfile.name = usernameInput.value.trim() || "–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫";
    currentProfile.avatar = avatarInput.value.trim() || "https://i.imgur.com/4ZQZ4Yy.png";
    currentProfile.voice = voicePreset.value;
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(currentProfile));
    syncProfileUI();
  }

  function resetProfile() {
    currentProfile = {
      name: "",
      avatar: "https://i.imgur.com/4ZQZ4Yy.png",
      voice: "base"
    };
    localStorage.removeItem(STORAGE_PROFILE);
    syncProfileUI();
  }

  function updateVoiceBadge() {
    const v = voicePreset.value;
    let text = "";
    if (v === "base") text = "normal (0)";
    if (v === "p200") text = "pitch +200 (—á—É—Ç—å –≤–∏—â–µ)";
    if (v === "m200") text = "pitch -200 (—á—É—Ç—å –Ω–∏–∂—á–µ)";
    if (v === "p400") text = "pitch +400 (–∞–Ω—ñ–º–µ –º–∞–ª—å—á—ñ–∫)";
    if (v === "m400") text = "pitch -400 (–¥—è–¥—è –∑ –ø—ñ–¥–≤–∞–ª–∞)";
    voiceBadge.textContent = "–ø—Ä–µ—Å–µ—Ç: " + text;
    voiceBadgeSidebar.textContent = voiceBadge.textContent;
  }

  voicePreset.addEventListener("change", () => {
    currentProfile.voice = voicePreset.value;
    updateVoiceBadge();
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(currentProfile));
  });

  // ------------------ 4. FEED (Firestore) ------------------
  const postText = document.getElementById("postText");
  const postImageUrl = document.getElementById("postImageUrl");
  const feedList = document.getElementById("feedList");

  const randomTags = [
    "#–∫—Ä—ñ–Ω–∂", "#–¥–µ–ø—Ä–∞", "#–≤–∞–π–±", "#–Ω—ñ—á—å", "#–¥–æ–ª–∂–Ω—ñ–∫",
    "#2007", "#–µ–º–æ", "#scene", "#–Ω—ñ—á–æ–≥–æ_–Ω–µ_–ø–æ–Ω—è–ª"
  ];

  function getTag() {
    return randomTags[Math.floor(Math.random() * randomTags.length)];
  }

  async function createPost() {
    if (!db) {
      alert("Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω, –ø–æ—Å—Ç–∏ –Ω–µ –ª–µ—Ç—è—Ç—å –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç. –ü–æ—Ç—Ä—ñ–±–µ–Ω firebaseConfig.");
      return;
    }
    const text = postText.value.trim();
    const img = postImageUrl.value.trim();
    if (!text) return;

    const now = new Date();
    const time = now.toLocaleTimeString();

    const docData = {
      text,
      image: img || null,
      author: currentProfile.name || "–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫",
      avatar: currentProfile.avatar || "",
      tag: getTag(),
      time,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("posts").add(docData);
    postText.value = "";
    postImageUrl.value = "";
  }

  function renderPost(doc) {
    const d = doc.data();
    const div = document.createElement("div");
    div.className = "post";

    const header = document.createElement("div");
    header.className = "post-header";

    const left = document.createElement("div");
    left.className = "post-user";

    const img = document.createElement("img");
    img.src = d.avatar || "https://i.imgur.com/4ZQZ4Yy.png";

    const name = document.createElement("span");
    name.className = "post-name";
    name.textContent = d.author || "–∞–Ω–æ–Ω—ñ–º";

    const timeSpan = document.createElement("span");
    timeSpan.textContent = d.time || "";

    left.appendChild(img);
    left.appendChild(name);
    left.appendChild(timeSpan);

    const right = document.createElement("span");
    right.className = "post-tag";
    right.textContent = d.tag || "#–≤–∞–π–±";

    header.appendChild(left);
    header.appendChild(right);

    const body = document.createElement("div");
    body.textContent = d.text || "";

    div.appendChild(header);
    div.appendChild(body);

    if (d.image) {
      const imgWrap = document.createElement("div");
      imgWrap.className = "post-image";
      const pic = document.createElement("img");
      pic.src = d.image;
      imgWrap.appendChild(pic);
      div.appendChild(imgWrap);
    }

    return div;
  }

  function subscribePosts() {
    if (!db || !feedList) return;
    db.collection("posts")
      .orderBy("createdAt", "desc")
      .limit(100)
      .onSnapshot(snap => {
        feedList.innerHTML = "";
        snap.forEach(doc => {
          feedList.appendChild(renderPost(doc));
        });
      });
  }

  function generateRandomPost() {
    const templates = [
      "–°–∏–∂—É –Ω–∞ mihalichparty —ñ –¥—É–º–∞—é: —Ü–µ –ª–µ—á–∏—Ç—å—Å—è —á–∏ –≤–∂–µ –≤—Å–µ?",
      "–ö–æ–ª–∏ –≤–∂–µ –∑–∞—Ä–ø–ª–∞—Ç–∞, —è–∫—â–æ —è –Ω–∞–≤—ñ—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞—é?",
      "–Ø –æ—Ñ—ñ—Ü—ñ–π–Ω–æ –¥–æ–ª–∂–Ω—ñ–∫, –Ω–æ —Ö–æ—á–∞ –± —Å—Ç–∏–ª—å–Ω–∏–π.",
      "–Ø–∫—â–æ —è –ø—Ä–æ–ø–∞–¥—É –∑ —Å–∞–π—Ç—É, –∑–Ω–∞—á—ñ—Ç –ú—ñ—Ö–∞–ª–∏—á –º–µ–Ω–µ –Ω–∞–π—à–æ–≤.",
      "–ù–∞–π–∫—Ä–∞—â–∏–π —Å–ø–æ—Ä—Ç ‚Äî —Ç—ñ–∫–∞—Ç–∏ –≤—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ.",
      "–ù—î–Ω—É –∞ —à–æ, —Ö–æ—á –¥–µ—Å—å —è –º–æ–∂—É —Å—Ç—Ä–∞–¥–∞—Ç—å –ª–µ–≥–∞–ª—å–Ω–æ.",
      "–ü–æ—Å—Ç–∞–≤–∏–≤ —Å–æ–±—ñ –Ω—ñ–∫ —ñ –≤–∂–µ –¥—É–º–∞—é —â–æ –≤ –º–µ–Ω–µ –æ–±—Ä–∞–∑.",
      "–í–∏ —Ç–æ–∂–µ —ñ–Ω–æ–≥–¥–∞ —Å–ª—É—Ö–∞—î—Ç–µ –º—É–∑–æ–Ω —ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î—Ç–µ —à–æ –≤–∏ –≤ –∫–ª—ñ–ø—ñ?",
      "–°—å–æ–≥–æ–¥–Ω—ñ –¥–µ–Ω—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ: —è –≤–∂–µ 4 –≥–æ–¥–∏–Ω–∏ –Ω–∏—á–æ –Ω–µ —Ä–æ–±–ª—é.",
      "–Ø–∫—â–æ –≤ –º–µ–Ω–µ –Ω–µ–º–∞ –ø–ª–∞–Ω—ñ–≤ ‚Äî —Ü–µ —Ç–µ–∂ –ø–ª–∞–Ω, –ø—Ä–∞–≤–∏–ª—å–Ω–æ?"
    ];
    postText.value = templates[Math.floor(Math.random() * templates.length)];
  }

  function clearMyPosts() {
    feedList.innerHTML = "";
  }

  // ------------------ 5. VOICE CHAT ------------------
  const voiceInput = document.getElementById("voiceInput");
  const voiceList = document.getElementById("voiceList");

  function pitchToSpeechVal(preset) {
    switch (preset) {
      case "p200": return 1.2;
      case "m200": return 0.8;
      case "p400": return 1.4;
      case "m400": return 0.6;
      default: return 1.0;
    }
  }

  function speakTextWithProfile(text, profileOrNull) {
    if (!window.speechSynthesis) {
      alert("–£ —Ç–µ–±–µ –Ω–µ–º–∞—î TTS –≤ –±—Ä–∞—É–∑–µ—Ä—ñ, –≥–æ–ª–æ—Å –Ω–µ –ø—Ä–∞—Ü—é—î. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏ —Å–µ–±–µ.");
      return;
    }
    const u = new SpeechSynthesisUtterance(text);
    const profile = profileOrNull || currentProfile;
    u.pitch = pitchToSpeechVal(profile.voice || "base");
    u.rate = 1.0;
    u.lang = "uk-UA";
    window.speechSynthesis.speak(u);
  }

  function testMyVoice() {
    const text = "–Ø —Ç–≤—ñ–π –≥–æ–ª–æ—Å–æ–≤–∏–π –ø—Ä–µ—Å–µ—Ç. –Ø –∑–≤—É—áy —Å—Ç—Ä–∞–Ω–Ω–æ, –Ω–æ —Ü–µ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ.";
    speakTextWithProfile(text, currentProfile);
  }

  async function sendVoice() {
    if (!db) {
      alert("Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω, –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç –Ω–µ –æ–Ω–ª–∞–π–Ω.");
      return;
    }
    const text = voiceInput.value.trim();
    if (!text) return;
    const now = new Date();
    const time = now.toLocaleTimeString();

    const docData = {
      text,
      author: currentProfile.name || "–∞–Ω–æ–Ω—ñ–º–Ω–∏–π –¥–æ–ª–∂–Ω—ñ–∫",
      avatar: currentProfile.avatar || "",
      voice: currentProfile.voice || "base",
      time,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("voices").add(docData);
    voiceInput.value = "";
  }

  function renderVoice(doc) {
    const d = doc.data();
    const item = document.createElement("div");
    item.className = "voice-item";

    const avatar = document.createElement("img");
    avatar.src = d.avatar || "https://i.imgur.com/4ZQZ4Yy.png";
    avatar.style.width = "26px";
    avatar.style.height = "26px";
    avatar.style.borderRadius = "999px";
    avatar.style.objectFit = "cover";
    avatar.style.border = "1px solid #4b5563";

    const metaWrap = document.createElement("div");
    metaWrap.className = "voice-meta";

    const top = document.createElement("div");
    top.className = "voice-top";
    const name = document.createElement("span");
    name.textContent = d.author || "–∞–Ω–æ–Ω—ñ–º";
    const time = document.createElement("span");
    time.textContent = d.time || "";
    const preset = document.createElement("span");
    preset.className = "badge-voice";
    preset.textContent = "preset: " + (d.voice || "base");

    top.appendChild(name);
    top.appendChild(time);
    top.appendChild(preset);

    const text = document.createElement("div");
    text.className = "voice-text";
    text.textContent = d.text || "";

    const playBtn = document.createElement("button");
    playBtn.className = "btn btn-sm";
    playBtn.textContent = "‚ñ∂ –ø—Ä–æ—Å–ª—É—Ö–∞—Ç—å";
    playBtn.addEventListener("click", () => {
      speakTextWithProfile(d.text || "", { voice: d.voice || "base" });
    });

    metaWrap.appendChild(top);
    metaWrap.appendChild(text);

    item.appendChild(avatar);
    item.appendChild(metaWrap);
    item.appendChild(playBtn);

    return item;
  }

  function subscribeVoices() {
    if (!db || !voiceList) return;
    db.collection("voices")
      .orderBy("createdAt", "desc")
      .limit(50)
      .onSnapshot(snap => {
        voiceList.innerHTML = "";
        snap.forEach(doc => {
          voiceList.appendChild(renderVoice(doc));
        });
      });
  }

  // ------------------ 6. DRAW / GRAFFITI ------------------
  const paintCanvas = document.getElementById("paintCanvas");
  const drawSize = document.getElementById("drawSize");
  let ctx = null;
  let drawing = false;
  let lastX = 0;
  let lastY = 0;
  let currentColor = "#f97316";

  function resizeCanvas() {
    if (!paintCanvas) return;
    const rect = paintCanvas.getBoundingClientRect();
    if (rect.width === 0) return; // —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ —Å—Ö–æ–≤–∞–Ω–∞ ‚Äì –Ω–µ —á—ñ–ø–∞—î–º–æ
    paintCanvas.width = rect.width;
    paintCanvas.height = 260;
    if (!ctx) ctx = paintCanvas.getContext("2d");
    // –ø—ñ—Å–ª—è —Ä–µ—Å–∞–π–∑—É –∑–∞–Ω–æ–≤–æ –ø—ñ–¥—Ç—è–≥–Ω–µ–º–æ —à—Ç—Ä–∏—Ö–∏ –∑ Firebase
    if (db) {
      subscribeStrokes(true);
    }
  }

  function getCanvasPos(e) {
    const rect = paintCanvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) {
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    } else {
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }
  }

  function startDraw(e) {
    drawing = true;
    const pos = getCanvasPos(e);
    lastX = pos.x;
    lastY = pos.y;
  }

  function moveDraw(e) {
    if (!drawing || !ctx) return;
    const pos = getCanvasPos(e);
    const size = parseInt(drawSize.value, 10) || 4;

    ctx.strokeStyle = currentColor;
    ctx.lineWidth = size;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();

    sendStrokeToFirestore(lastX, lastY, pos.x, pos.y, currentColor, size);

    lastX = pos.x;
    lastY = pos.y;
  }

  function stopDraw() {
    drawing = false;
  }

  function clearLocalCanvas() {
    if (!ctx || !paintCanvas) return;
    ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height);
  }

  async function sendStrokeToFirestore(x1, y1, x2, y2, color, size) {
    if (!db) return;
    try {
      await db.collection("strokes").add({
        x1, y1, x2, y2,
        color,
        size,
        author: currentProfile.name || "–∞–Ω–æ–Ω—ñ–º",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (e) { }
  }

  function drawStroke(d) {
    if (!ctx || !paintCanvas) return;
    ctx.strokeStyle = d.color || "#f97316";
    ctx.lineWidth = d.size || 4;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(d.x1, d.y1);
    ctx.lineTo(d.x2, d.y2);
    ctx.stroke();
  }

  let strokesUnsub = null;
  function subscribeStrokes(force) {
    if (!db || !paintCanvas) return;
    if (strokesUnsub && !force) return;
    if (strokesUnsub) strokesUnsub();
    strokesUnsub = db.collection("strokes")
      .orderBy("createdAt", "asc")
      .limit(2000)
      .onSnapshot(snap => {
        clearLocalCanvas();
        snap.forEach(doc => drawStroke(doc.data()));
      });
  }

  document.querySelectorAll(".color-dot").forEach(dot => {
    dot.addEventListener("click", () => {
      currentColor = dot.dataset.color;
    });
  });

  // ------------------ 7. GAMES + LEADERBOARD ------------------
  let clickScore = 0;
  const scoreClickBadge = document.getElementById("scoreClickBadge");
  const clickComment = document.getElementById("clickComment");

  function updateClickScoreBadge() {
    scoreClickBadge.textContent = "clicker: " + clickScore;
  }

  function randomClickComment() {
    const list = [
      "–∑ —Ç–∞–∫–∏–º —Å—Ç–∞—Ä–∞–Ω–Ω—è–º —Ç–∏ –º—ñ–≥ –±–∏ —É—Ä–æ–∫–∏ —Ä–æ–±–∏—Ç–∏.",
      "—Ç–∏ –ø—Ä–æ—Å—Ç–æ –≤–±–∏–≤–∞—î—à –∫–Ω–æ–ø–∫—É, –æ—Å—Ç–∞–≤ —ó—ó –≤ –ø–æ–∫–æ—î.",
      "–µ—â–µ —á—É—Ç—å-—á—É—Ç—å —ñ –≤ —Ç–µ–±–µ –±—É–¥–µ —Ç—Ä–∞–≤–º–∞ –ø–∞–ª—å—Ü—è.",
      "—è –¥–∏–≤–ª—é—Å—å –Ω–∞ —Ç–µ–±–µ —ñ –¥—É–º–∞—é: '–Ω—É —Ö–æ—á –π–æ–º—É –≤–µ—Å–µ–ª–æ'.",
      "—Ç–∏ —É–∂–µ –≤–∏–≥—Ä–∞–≤? –Ω–µ—Ç. –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É–π.",
      "–º—ñ—Ö–∞–ª–∏—á —Å–ª—ñ–¥–∫—É—î –∑–∞ —Ç–æ–±–æ–π —ñ –∑–∞–ø–∏—Å—É—î –¥–æ–ª–≥–∏.",
      "–∑–∞—á—î–º —Ç–∏ —Ü–µ —Ä–æ–±–∏—à? –∞—Ö –¥–∞, –±–æ –ø—Ä–∏–∫–æ–ª—å–Ω–æ.",
      "–∫–æ–∂–µ–Ω –∫–ª—ñ–∫ ‚Äî —Ü–µ –º—ñ–Ω—É—Å 1 –Ω–µ–π—Ä–æ–Ω, –ø–ª—é—Å 1 –≤–∞–π–±."
    ];
    return list[Math.floor(Math.random() * list.length)];
  }

  function clickGame() {
    clickScore++;
    updateClickScoreBadge();
    if (Math.random() < 0.3) {
      clickComment.textContent = randomClickComment();
    }
  }

  function resetClickGame() {
    clickScore = 0;
    updateClickScoreBadge();
    clickComment.textContent = "—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ –ø–æ—á–∞–≤ –∂–∏—Ç—Ç—è –∑ –Ω—É–ª—è (–∑–Ω–æ–≤—É).";
  }

  let reactionState = "idle";
  let reactionStartTime = 0;
  let reactionBest = null;
  const reactBox = document.getElementById("reactBox");
  const reactComment = document.getElementById("reactComment");
  const scoreReactBadge = document.getElementById("scoreReactBadge");

  function startReactionGame() {
    reactionState = "waiting";
    reactComment.textContent = "–∂–¥–∏, –Ω–µ –∫–ª—ñ–∫–∞–π, –∫–æ—Ä–æ–±–∫–∞ —Å–∞–º–∞ –ø–æ–∑–µ–ª–µ–Ω—ñ—î...";
    reactBox.style.background = "#451a1a";
    reactBox.textContent = "–∂–¥—å–æ–º —Å–∏–≥–Ω–∞–ª –≤—ñ–¥ –ú—ñ—Ö–∞–ª–∏—á–∞...";
    const delay = 1000 + Math.random() * 3000;
    setTimeout(() => {
      if (reactionState !== "waiting") return;
      reactionState = "ready";
      reactBox.style.background = "#14532d";
      reactBox.textContent = "–ö–õ–Ü–ö–ê–ô –ó–ê–†–ê–ó!!!";
      reactionStartTime = performance.now();
    }, delay);
  }

  reactBox.addEventListener("click", () => {
    if (reactionState === "waiting") {
      reactComment.textContent = "—Ä–∞–Ω–æ –∫–ª–∞—Ü–Ω—É–≤, —Ç–∏ –Ω–µ—Ç–µ—Ä–ø–ª—è—á–∏–π. —Å–ø—Ä–æ–±—É–π –∑–Ω–æ–≤—É.";
      reactionState = "idle";
      reactBox.style.background = "#451a1a";
      reactBox.textContent = "–∂–¥—å–æ–º —Å—Ç–∞—Ä—Ç...";
    } else if (reactionState === "ready") {
      const t = performance.now() - reactionStartTime;
      reactionState = "idle";
      reactBox.style.background = "#451a1a";
      reactBox.textContent = "–∂–¥—å–æ–º —Å—Ç–∞—Ä—Ç...";
      const ms = Math.round(t);
      if (reactionBest === null || ms < reactionBest) {
        reactionBest = ms;
        scoreReactBadge.textContent = "reaction best: " + reactionBest + " ms";
        reactComment.textContent = "–∫—Ä–∞—Å–∞–≤–∞, –Ω–æ–≤–∏–π —Ä–µ–∫–æ—Ä–¥: " + ms + " ms. –º–æ–∑–≥ —â–µ –∂–∏–≤–∏–π.";
      } else {
        reactComment.textContent = "—Ç–≤—ñ–π —á–∞—Å: " + ms + " ms. –º–æ–∂–µ—à –∫—Ä–∞—â–µ.";
      }
    }
  });

  const leaderboardDivFeed = document.getElementById("leaderboard");
  const leaderboardDivGames = document.getElementById("leaderboardGames");

  async function saveScore(type) {
    if (!db) {
      alert("Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω, —Ç–æ–ø –Ω–µ –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è.");
      return;
    }
    if (!currentProfile.name) {
      alert("–≤–∫–∞–∂–∏ –Ω—ñ–∫ –≤ –∞–∫–∫–∞—É–Ω—Ç—ñ –ø–µ—Ä–µ–¥ —Ç–∏–º —è–∫ –ª—ñ–∑—Ç–∏ –≤ —Ç–æ–ø–∏.");
      return;
    }

    if (type === "clicker") {
      const score = clickScore;
      await db.collection("scores").add({
        type: "clicker",
        user: currentProfile.name,
        score,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("—Ä–µ–∑—É–ª—å—Ç–∞—Ç clicker –∑–±–µ—Ä–µ–∂–µ–Ω.");
    } else if (type === "reaction") {
      if (reactionBest === null) {
        alert("—â–µ –Ω–µ –±—É–ª–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–º—ñ—Ä—É —Ä–µ–∞–∫—Ü—ñ—ó.");
        return;
      }
      const score = reactionBest;
      await db.collection("scores").add({
        type: "reaction",
        user: currentProfile.name,
        score,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("—Ä–µ–∑—É–ª—å—Ç–∞—Ç reaction –∑–±–µ—Ä–µ–∂–µ–Ω.");
    }
  }

  function renderLeaderboardPart(title, snap, container) {
    const section = document.createElement("div");
    const h = document.createElement("div");
    h.textContent = title;
    h.style.fontSize = "11px";
    h.style.fontWeight = "700";
    h.style.margin = "4px 0 4px";
    section.appendChild(h);

    snap.forEach(doc => {
      const d = doc.data();
      const row = document.createElement("div");
      row.className = "lb-row";
      const name = document.createElement("span");
      name.textContent = d.user || "–∞–Ω–æ–Ω—ñ–º";
      const score = document.createElement("span");
      score.textContent = d.score;
      row.appendChild(name);
      row.appendChild(score);
      section.appendChild(row);
    });

    container.appendChild(section);
  }

  function subscribeLeaderboard() {
    if (!db) return;

    function updateLeaderboards() {
      if (leaderboardDivFeed) leaderboardDivFeed.innerHTML = "";
      if (leaderboardDivGames) leaderboardDivGames.innerHTML = "";

      db.collection("scores")
        .where("type", "==", "clicker")
        .orderBy("score", "desc")
        .limit(10)
        .onSnapshot(snap => {
          if (leaderboardDivFeed) leaderboardDivFeed.innerHTML = "";
          if (leaderboardDivGames) leaderboardDivGames.innerHTML = "";
          renderLeaderboardPart("CLICKER TOP", snap, leaderboardDivFeed);
          renderLeaderboardPart("CLICKER TOP", snap, leaderboardDivGames);
        });

      db.collection("scores")
        .where("type", "==", "reaction")
        .orderBy("score", "asc")
        .limit(10)
        .onSnapshot(snap => {
          renderLeaderboardPart("REACTION TOP (ms, –º–µ–Ω—à–µ –∫—Ä–∞—â–µ)", snap, leaderboardDivFeed);
          renderLeaderboardPart("REACTION TOP (ms, –º–µ–Ω—à–µ –∫—Ä–∞—â–µ)", snap, leaderboardDivGames);
        });
    }

    updateLeaderboards();
  }

  // ------------------ INIT ------------------
  window.addEventListener("load", () => {
    loadProfile();
    updateClickScoreBadge();

    if (paintCanvas) {
      ctx = paintCanvas.getContext("2d");
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      paintCanvas.addEventListener("mousedown", e => { e.preventDefault(); startDraw(e); });
      paintCanvas.addEventListener("mousemove", moveDraw);
      paintCanvas.addEventListener("mouseup", stopDraw);
      paintCanvas.addEventListener("mouseleave", stopDraw);

      paintCanvas.addEventListener("touchstart", e => { e.preventDefault(); startDraw(e); }, { passive: false });
      paintCanvas.addEventListener("touchmove", e => { e.preventDefault(); moveDraw(e); }, { passive: false });
      paintCanvas.addEventListener("touchend", e => { e.preventDefault(); stopDraw(); }, { passive: false });
    }

    if (db) {
      subscribePosts();
      subscribeVoices();
      subscribeStrokes();
      subscribeLeaderboard();
    } else {
      console.warn("Firebase –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω ‚Äî –≤—Å–µ –∂–∏–≤–µ —Ç—ñ–ª—å–∫–∏ —É —Ç–µ–±–µ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ.");
    }
  });
</script>
</body>
</html>
